name: CD - Semantic Release

on:
  workflow_call:
    inputs:
      stack:
        description: 'Stack the project. (node | php | dotnet | python | go | empty for auto-detect)'
        required: false
        type: string
        default: "auto"
      project_path:
        description: 'Project path source code'
        required: false
        type: string
        default: "."

      dry_run:
        description: 'Dry run mode for semantic-release. (default: false -> true for PRs)'
        required: false
        type: boolean
        default: false
      debug:
        description: 'Debug mode for semantic-release.'
        required: false
        type: boolean
        default: false
      commit_strict_mode:
        description: 'Fail pipeline if no conventional commits are found'
        required: false
        type: boolean
        default: true

    secrets:
      GH_TOKEN:
        required: true

permissions:
  actions: read         
  contents: write       # â†’ permite criar e atualizar tags, commits e pushes no repositÃ³rio.
  issues: write         # (opcional) â†’ se vocÃª quiser que o release crie comentÃ¡rios em issues.
  pull-requests: write  # (opcional) â†’ se quiser que o release comente em PRs.
  checks: read          # (opcional) â†’ se precisar ler check runs

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    env:
      REUSABLE_PATH: ${{ github.workspace }}/__reusable_files__
      BASH_ENV: ${{ github.workspace }}/__reusable_files__/scripts/shared/shell-helpers.sh

    # defaults:
    #   run:
    #     shell: bash
    #     working-directory: ${{ needs.workdir.outputs.path || '.' }}

    steps:
    - name: ðŸ“Œ Checkout consumer repository
      uses: actions/checkout@v4
      with:
        # A linha 'ref: ${{ github.event.workflow_run.head_sha }}
        fetch-depth: 0 # NecessÃ¡rio para o semantic-release inspecionar histÃ³rico
        fetch-tags: true # NecessÃ¡rio para o semantic-release inspecionar tags
        persist-credentials: true # â†’ permite push com GITHUB_TOKEN
        token: ${{ secrets.GH_TOKEN }} # NecessÃ¡rio para autenticar PUSH

    - name: ðŸ“Œ Checkout reusable repository
      uses: actions/checkout@v4
      with:
        repository: heliomarpm/reusable-workflows
        ref: main # ${{ github.ref }}
        path: ${{ env.REUSABLE_PATH }}

    - name: ðŸ“ Resolve project path
      id: path
      run: |
        PROJECT_PATH="$(resolve_project_path '${{ inputs.project_path }}')"
        log "ðŸ”¹ Using project path: $PROJECT_PATH"
        echo "value=$PROJECT_PATH" >> "$GITHUB_OUTPUT"

    - name: ðŸ‘€ Files in workspace
      run: |
        ls_files

    - name: ðŸ” Resolve project stack
      id: stack
      working-directory: ${{ steps.path.outputs.value }}
      run: |
        STACK="${{ inputs.stack }}"
        if [[ -n "$STACK" && "$STACK" != "auto" ]]; then
          echo "ðŸ”¹ Using stack from input: $STACK"
          echo "value=$STACK" >> $GITHUB_OUTPUT
          echo "source=input" >> $GITHUB_OUTPUT
          exit 0
        fi

        SCRIPT="$REUSABLE_PATH/scripts/shared/detect-stack.sh"
        chmod +x "$SCRIPT"
        STACK=$("$SCRIPT" "${{ steps.path.outputs.value }}")

        echo "value=$STACK" >> $GITHUB_OUTPUT
        echo "source=detected" >> $GITHUB_OUTPUT

    - name: âŒ Fail if stack not detected
      if: steps.stack.outputs.value == ''
      run: fail "Stack not detected. Check project_path or repository structure."

    - name: âš™ï¸ Configurar UsuÃ¡rio Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: ðŸš€ Run Semantic Release
      if: steps.stack.outputs.value != ''
      # working-directory: ${{ github.workspace }}
      working-directory: ${{ steps.path.outputs.value }}
      run: |
        SCRIPT="$REUSABLE_PATH/scripts/shared/semantic-release/run.sh"
        chmod +x "$SCRIPT"
        "$SCRIPT"
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        REUSABLE_PATH: ${{ env.REUSABLE_PATH }}
        STACK: ${{ steps.stack.outputs.value }}
        IS_DRY_RUN: ${{ inputs.dry_run }}
        IS_DEBUG: ${{ inputs.debug }}
        IS_STRICT_MODE: ${{ inputs.commit_strict_mode }}

    - name: ðŸ§¾ Job Summary
      if: always()
      run: |
        {
          echo "## ðŸ“Œ Semantic Release"
          echo ""
          echo "**ðŸ“‚ Project path:** \`${{ inputs.project_path }}\`"
          echo ""

          if [[ "${{ steps.stack.outputs.value }}" != "" ]]; then
            echo "**ðŸ§± Stack:** \`${{ steps.stack.outputs.value }}\` (_${{ steps.stack.outputs.source }}_)"
          else
            echo "**ðŸ§± Stack:** âŒ not detected"
          fi
        } >> $GITHUB_STEP_SUMMARY
